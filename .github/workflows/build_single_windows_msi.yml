name: Build Single Windows (MSI)

on:
  workflow_dispatch:
    inputs:
      url:
        description: "Web URL to package"
        required: true
        default: "http://34.96.239.88:8989/"
        type: string
      name:
        description: "Application name (can be Chinese, e.g. 欧联)"
        required: true
        default: "欧联"
        type: string
      icon:
        description: "Icon URL or path (jpg/png/ico). If not .ico, will auto-convert to 256x256 .ico"
        required: false
        default: ""
        type: string

permissions:
  contents: read

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable-x86_64-msvc
          profile: minimal
          override: true
          target: x86_64-pc-windows-msvc

      - name: Build CLI
        shell: pwsh
        run: |
          Remove-Item -Force -ErrorAction SilentlyContinue dist/cli.js
          npm run cli:build

      - name: Prepare icon (auto convert to .ico)
        shell: pwsh
        run: |
          # UTF-8 for WiX and logs
          try { [Console]::OutputEncoding = [System.Text.Encoding]::UTF8 } catch {}
          cmd /c chcp 65001 > $null

          $iconInput = "${{ inputs.icon }}"
          $outIco = ""
          if ($iconInput -ne "") {
            if ($iconInput.ToLower().EndsWith(".ico")) {
              $outIco = $iconInput
              Write-Host "Using .ico directly: $outIco"
            } else {
              Write-Host "Icon is not .ico, downloading and converting to 256x256 .ico..."
              $workDir = Join-Path $env:RUNNER_TEMP "pake-icon"
              New-Item -ItemType Directory -Force -Path $workDir | Out-Null
              $downloadPath = Join-Path $workDir "icon_input"
              if ($iconInput.StartsWith("http")) {
                Invoke-WebRequest -Uri $iconInput -OutFile $downloadPath -UseBasicParsing
              } else {
                Copy-Item -Force $iconInput $downloadPath
              }
              python -m pip install --upgrade pip | Out-Null
              python -m pip install Pillow | Out-Null
              $icoPath = Join-Path $workDir "icon_256.ico"
              $env:PAKE_ICON_IN = $downloadPath
              $env:PAKE_ICON_OUT = $icoPath
              $py = @'
from PIL import Image
import os

src = os.environ.get("PAKE_ICON_IN")
dst = os.environ.get("PAKE_ICON_OUT")

img = Image.open(src).convert("RGBA").resize((256, 256))
img.save(dst, format="ICO")
print("ICON_CONVERT_OK", dst)
'@
              $py | python -
              $outIco = $icoPath
              Write-Host "Converted icon: $outIco"
            }
          } else {
            Write-Host "No icon provided, will use default."
          }

          # Export for next step
          "PAKE_ICON_ICO=$outIco" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Build Windows MSI
        shell: pwsh
        run: |
          # UTF-8 for WiX
          try { [Console]::OutputEncoding = [System.Text.Encoding]::UTF8 } catch {}
          cmd /c chcp 65001 > $null

          $args = @("${{ inputs.url }}", "--name", "${{ inputs.name }}", "--target", "win")
          if ($env:PAKE_ICON_ICO -ne "") {
            $args += @("--icon", $env:PAKE_ICON_ICO)
          }
          Write-Host "Running: node cli.js $($args -join ' ')"
          & node cli.js $args

      - name: Collect outputs
        shell: pwsh
        run: |
          Write-Host "=== Outputs ==="
          Get-ChildItem -Recurse -Filter "*.msi" -ErrorAction SilentlyContinue | Select-Object FullName, Length, LastWriteTime
          Get-ChildItem -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue | Select-Object FullName, Length, LastWriteTime

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-msi-${{ inputs.name }}-${{ github.run_number }}
          path: |
            *.msi
            src-tauri/target/release/bundle/msi/*.msi
            *.exe
            src-tauri/target/release/*.exe
          if-no-files-found: error
          retention-days: 7

